<!DOCTYPE html>
<html lang="en">

<style>

    table {
        font-family: Bahnschrift, sans-serif;
        font-size: 13px;
        border-collapse: collapse;
        margin: 5px;
    }

    td, th {
        border: 1px solid #a8a8a8;
        padding: 5px;
    }

    th {
        background-color: #ffffff;
        font-size: 14px;
        padding: 7px;
    }

    tr:nth-child(odd) {
        background-color: #ececec;
    }

    tr:hover {
        background-color: #b7b7b7;
    }

    tr:active td, th:active {
        background-color: #646464;
    }

    .inputSection {
        font-family: Bahnschrift, sans-serif;
        padding: 7px;
    }

    .inputField {
        padding: 3px;
    }

    .buttonSection {
        font-family: Bahnschrift, sans-serif;
        padding: 10px;
    }

    .selected {
        border: 3px solid #626262;
    }

</style>

<script>
    //Set up our boolean for Ascending/Descending sort
    let sortDirection = false;
    //Import our database as an array of each cell with all special characters removed
    let studentsTemp = [{{ students | tojson | safe }}];
    let carsTemp = [{{ cars | tojson | safe }}]
    //Initialize other various vars we'll need
    let student_tableData = [];
    let car_tableData = [];
    let tempInt = 0;
    let studentSelectedKey;
    let studentSelectedRow;
    let selectedRowIndex;

    //Concatenate our array of cells into one string, then split the string at the commas
    //This polishes the data so we can easily work with it
    console.log(studentsTemp);
    studentsTemp = studentsTemp.toString();
    console.log(studentsTemp);
    student_normalArray = studentsTemp.split(',');
    console.log(student_normalArray);

    //This for loop populates our student_tableData table-array with the data from our array of cells
    //I deemed it a table-array because each element acts as a row, holding 5 other elements that count as the
    //columns for that row.
    //In order to populate it, we take the first 5 elements of our normal array and store them as individual elements
    //in our table-array. Then, we increment our for loop by 5, landing us at the next student id in the normal array,
    //as well as increment tempInt by 1, which acts as a counter for which row we're on in the table-array.
    //Once finished, this leaves us with an array formatted for easy use with a table.
    for (let i = 0; i < student_normalArray.length; i = i + 5)
    {
        student_tableData[tempInt] = { id: student_normalArray[i], firstName: student_normalArray[i+1], lastName: student_normalArray[i+2], classNumber: student_normalArray[i+3], checkedOut: student_normalArray[i+4] }
        tempInt++;
    }
    
    //Do the same thing for the car table
    //-----------------------------------
    carsTemp = carsTemp.toString();
    car_normalArray = carsTemp.split(',');
    tempInt = 0;

    console.log(car_normalArray);

    for (let j = 0; j < car_normalArray.length; j = j + 6)
    {
        car_tableData[tempInt] = { carPlate: car_normalArray[j], carMake: car_normalArray[j+1], carModel: car_normalArray[j+2], carColor: car_normalArray[j+3], id: car_normalArray[j+4], guest: car_normalArray[j+5]}
        tempInt++;
    }
    //-----------------------------------

    window.onload = () =>
    {
        loadStudentTableData(student_tableData);
    }

    //Function to load our student table's data dynamically
    function loadStudentTableData(student_tableData, row)
    {
        //Set a constant variable to refer to studentTable defined in our HTML
        const tableBody = document.getElementById('studentTable');
        //Set up our input data variable as an empty string
        let dataHtml = '';

        //Iterate through our table of student data and append each row to dataHtml
        for(let student of student_tableData)
        {
            dataHtml += `<tr onclick="selectStudent(${student.id}, this);
                            drawSelectBorder(this);
                            selectedRowIndex = this.rowIndex - 1;">
                        <td>${student.id}</td>
                        <td>${student.firstName}</td>
                        <td>${student.lastName}</td>
                        <td>${student.classNumber}</td>
                        <td>${student.checkedOut}</td>`;
        }

        //Set our table's body to all the data housed within dataHtml
        tableBody.innerHTML = dataHtml;
    }

    //Function to load our car table's data dynamically
    function loadCarTableData(car_tableData)
    {
        //Set a constant variable to refer to carTable defined in our HTML
        const tableBody = document.getElementById('carTable');
        //Set up our input data variable as an empty string
        let dataHtml = '';

        //Iterate through our table of car data and append each row to dataHtml
        for(let car of car_tableData)
        {
            dataHtml += `<tr onclick="selectStudent(${car.id});" ><td>${car.carPlate}</td>
                        <td>${car.carMake}</td>
                        <td>${car.carModel}</td>
                        <td>${car.carColor}</td>
                        <td>${car.guest}</td>`;
        }

        //Set our table's body to all the data housed within dataHtml
        tableBody.innerHTML = dataHtml;
    }

    function sortColumn(columnName)
    {
        //Negate our sortDirection so it sorts the other way around
        sortDirection = !sortDirection;

        returnSortedColumn(sortDirection, columnName);

        //Reload our table data
        loadStudentTableData(student_tableData, studentSelectedRow);
    }

    function returnSortedColumn(sortDirection, columnName)
    {
        //Sort all the column's elements based on the boolean:
        //If true, Ascending. If false, Descending.
        //Ngl no idea why this works but it does so ¯\_(ツ)_/¯
        student_tableData = student_tableData.sort((s1, s2) =>
        {
            return sortDirection ? -(s1[columnName] < s2[columnName]) :
                -(s1[columnName] > s2[columnName])
        });

    }


    function selectStudent(sid, row)
    {
        //Initialize an array to hold our filtered table-array
        let filteredCarsTable = []

        studentSelectedKey = sid;
        studentSelectedRow = row;

        //Iterate through our car database and find any entry that has a matching id to the student
        //we selected. Append that entry to the filtered table-array
        for (let i = 0; i < car_tableData.length; i++)
        {
            if (car_tableData[i].id == sid)
            {
                filteredCarsTable.push(car_tableData[i]);
            }
        }

        //Reload our car table
        loadCarTableData(filteredCarsTable);
    }

    //Draw a thick border around the currently selected row
    function drawSelectBorder(row)
    {
        //Create a variable that holds all current selected rows (should be only one)
        let prevSelect = row.parentNode.querySelector('tr.selected');
        //Remove the selected tag from the current selected rows and add the selected tag to the new selection
        prevSelect && prevSelect.classList.remove('selected');
        row.classList.add('selected');
    }

    //This function is still under construction and is current not called
    function redrawSelectBorder(row)
    {
        for (let i = 0; i < student_tableData.length; i++)
        {
            if (student_tableData[i].id == studentSelectedKey)
            {
                row.classList.remove('selected');
                drawSelectBorder(row);
                return;
            }
        }
    }

    //Hide an element so it doesn't show on the page
    function hideDiv(element)
    {
        let temp = document.getElementById(element);
        temp.style.display = "none";
    }

    //Unhide an element so it displays on the page, while hiding all other hidden elements
    function unhideDiv(element)
    {
        console.log(element);
        let temp = document.getElementById(element);
        temp.style.display = "block";

        //If the element we're unhiding is editInput, populate the text fields with the currently
        //selected student's info and hide addInput
        if(element == 'editInput')
        {
            hideDiv('addInput');
            document.getElementById('editInputId').value = student_tableData[selectedRowIndex].id;
            document.getElementById('editOgId').value = student_tableData[selectedRowIndex].id;
            document.getElementById('editInputFirstName').value = student_tableData[selectedRowIndex].firstName;
            document.getElementById('editInputLastName').value = student_tableData[selectedRowIndex].lastName;
            document.getElementById('editInputClassNumber').value = student_tableData[selectedRowIndex].classNumber;
            document.getElementById('editInputCheckedOut').value = (student_tableData[selectedRowIndex].checkedOut === 'true');
        }

        //If the element we're unhiding is addInput, hide editInput
        if(element == 'addInput')
        {
            hideDiv('editInput');
        }
    }

    function removeStudent()
    {
        //If there is a currently selected student
        if (studentSelectedRow)
        {
            //Set our hidden form's value to the student's id
            document.getElementById('removeButtonId').value = student_tableData[selectedRowIndex].id;
        }
    }

</script>

<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>

<body>
    <div class="tableSection">
        <table style="float: left;">
            <thead>
            <tr>
                <th onclick="sortColumn('id')">Student ID</th>
                <th onclick="sortColumn('firstName')">First Name</th>
                <th onclick="sortColumn('lastName')">Last Name</th>
                <th onclick="sortColumn('classNumber')">Classroom</th>
                <th onclick="sortColumn('checkedOut')">Checked Out?</th>
            </tr>
            </thead>
            <tbody id="studentTable"></tbody>
        </table>
        <table style="float: left">
            <thead>
            <tr>
                <th onclick="sortColumn('carPlate')">License Plate</th>
                <th onclick="sortColumn('carMake')">Make</th>
                <th onclick="sortColumn('carModel')">Model</th>
                <th onclick="sortColumn('carColor')">Color</th>
                <th onclick="sortColumn('guest')">Guest?</th>
            </tr>
            </thead>
            <tbody id="carTable"></tbody>
        </table>
    </div>
    <div class="buttonSection" style="clear: both">
        <button type="button" onclick="unhideDiv('addInput')">Add Student</button>
        <button type="button" onclick="unhideDiv('editInput')">Edit Student</button>
        <form action="database/remove" method="post" style="display: inline-block">
                <input type="submit" name="removeButton" value="Remove Student" onclick="removeStudent(); return confirm('Are you sure you wish to remove this student?')">
                <input id="removeButtonId" type="hidden" name="removeButtonId" value="null">
        </form>
    </div>
    <div class="inputSection" id="addInput" style="clear: both; display: none">
        <form action="database/add" method="post">
            <div class="inputField">
                <label for="id">Student ID:</label><br>
                <input type="text" name="id" required><br>
            </div>
            <div class="inputField">
                <label for="firstName">First Name:</label><br>
                <input type="text" name="firstName" required><br>
            </div>
            <div class="inputField">
                <label for="lastName">Last Name:</label><br>
                <input type="text" name="lastName" required><br>
            </div>
            <div class="inputField">
                <label for="classNumber">Classroom:</label><br>
                <input type="text" name="classNumber" required><br>
            </div>
            <div class="inputField">
                <button type="submit" class="btn">Submit</button>
                <button type="reset" onclick="hideDiv('addInput')">Cancel</button>
            </div>
        </form>
    </div>
    <div class="inputSection" id="editInput" style="clear: both; display: none">
        <form action="database/edit" method="post">
            <div class="inputField">
                <label for="id">Student ID:</label><br>
                <input id="editInputId" type="text" name="id" value="test" required><br>
                <input id="editOgId" type="hidden" name="ogId" value="test" required><br>
            </div>
            <div class="inputField">
                <label for="firstName">First Name:</label><br>
                <input id="editInputFirstName" type="text" name="firstName" placeholder= required><br>
            </div>
            <div class="inputField">
                <label for="lastName">Last Name:</label><br>
                <input id="editInputLastName" type="text" name="lastName" required><br>
            </div>
            <div class="inputField">
                <label for="classNumber">Classroom:</label><br>
                <input id="editInputClassNumber" type="text" name="classNumber" required><br>
            </div>
            <div class="inputField">
                <label for="checkedOut">Checked Out?</label><br>
                <input id="editInputCheckedOut" type="checkbox" name="checkedOut"><br>
            </div>
            <div class="inputField">
                <button type="submit" class="btn">Submit</button>
                <button type="reset" onclick="hideDiv('editInput')">Cancel</button>
            </div>
        </form>
        <form>
            <input id="idToRemove" type="hidden">
        </form>
    </div>
</body>

</html>